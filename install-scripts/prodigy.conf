upstream prodigyimages {
  server localhost:8090  fail_timeout=20s;
  keepalive 32;
}

upstream layoutanalysis01 {
  server localhost:8010  fail_timeout=20s;
  keepalive 32;
}

upstream layoutanalysis02 {
  server localhost:8020  fail_timeout=20s;
  keepalive 32;
}

upstream layoutanalysis03 {
  server localhost:8030  fail_timeout=20s;
  keepalive 32;
}

upstream scriptdetection {
  server localhost:8050 fail_timeout=20s;
  keepalive 32;
}

upstream reviewlayoutannotation {
  server localhost:8060 fail_timeout=20s;
  keepalive 32;
}

upstream stt_ab {
  server localhost:8110 fail_timeout=20s;
  keepalive 32;
}

upstream stt_cs {
  server localhost:8120 fail_timeout=20s;
  keepalive 32;
}

upstream stt_mv {
  server localhost:8130 fail_timeout=20s;
  keepalive 32;
}

upstream stt_ns {
  server localhost:8140 fail_timeout=20s;
  keepalive 32;
}

upstream stt_tt {
  server localhost:8150 fail_timeout=20s;
  keepalive 32;
}

server {
    listen 80;

    # listen 443 ssl;
    # ssl_certificate      /etc/letsencrypt/live/prodigy.bdrc.io/fullchain.pem;
    # ssl_certificate_key  /etc/letsencrypt/live/prodigy.bdrc.io/privkey.pem;
    # include ssl_params;

    server_name prodigy.bdrc.io ;
    location /crop_images/ {
        proxy_pass http://prodigyimages/;
        proxy_http_version   1.1;
        proxy_redirect       off;
        proxy_set_header  Connection         "";
        proxy_set_header  Host               $host;
        proxy_set_header  X-Real-IP          $remote_addr;
        proxy_set_header  X-Forwarded-For    $proxy_add_x_forwarded_for;
        proxy_set_header  X-Forwarded-Proto  $scheme;
    }
    location /layout_analysis_01/ {
        proxy_pass http://layoutanalysis01/;
        proxy_http_version 1.1;
        proxy_redirect off;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /layout_analysis_02/ {
        proxy_pass http://layoutanalysis02/;
        proxy_http_version 1.1;
        proxy_redirect off;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /layout_analysis_03/ {
        proxy_pass http://layoutanalysis03/;
        proxy_http_version 1.1;
        proxy_redirect off;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /script_detection/ {
        proxy_pass http://scriptdetection/;
        proxy_http_version 1.1;
        proxy_redirect off;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /review_layout_annotation/ {
        proxy_pass http://reviewlayoutannotation/;
        proxy_http_version 1.1;
        proxy_redirect off;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /stt_ab/ {
        proxy_pass http://stt_ab/;
        proxy_http_version 1.1;
        proxy_redirect off;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /stt_cs/ {
        proxy_pass http://stt_cs/;
        proxy_http_version 1.1;
        proxy_redirect off;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /stt_mv/ {
        proxy_pass http://stt_mv/;
        proxy_http_version 1.1;
        proxy_redirect off;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /stt_ns/ {
        proxy_pass http://stt_ns/;
        proxy_http_version 1.1;
        proxy_redirect off;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    location /stt_tt/ {
        proxy_pass http://stt_tt/;
        proxy_http_version 1.1;
        proxy_redirect off;
        proxy_set_header Connection "";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
    include acmechallenge.conf;

    gzip_min_length     1000;
    gzip_buffers        4 8k;
    gzip_types          text/plain text/css;
    gzip_vary           on;
    gzip on ;

    proxy_set_header Host              $http_host;
    proxy_set_header X-Forwarded-For   $remote_addr;
    proxy_set_header X-Forwarded-Proto $scheme;
}
